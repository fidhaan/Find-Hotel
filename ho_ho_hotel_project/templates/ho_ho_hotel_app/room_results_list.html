{% extends "base.html" %}
{% load static %}
{% load favorite_extras %}
{% block title %}{{ title }}{% endblock %}

{% block section %}

    <div class="container my-9" style="min-height: 100vh; margin-top: 300px;">
        <h1 class="h2 font-weight-bold text-dark mb-4">
            Search ðŸ”Ž
        </h1>

        <div class="card p-3 mb-4 bg-light shadow-sm">
            <h5 class="mb-2">Search:</h5>
            <form method="GET" action="{% url 'room_results' %}"> 
                {% csrf_token %} 
                <div class="input-group">
                    {{ form.query }}
                    <button style="background-color: rgb(3, 160, 3); border: 0px solid;" class="btn btn-primary" type="submit">Search</button>
                </div>
            </form>
            <a style="background-color: rgb(0, 37, 0); padding: 10px; color: white; width: 100px; text-decoration: none;" href="{% url 'room_search' %}" class="small mt-2">Clear Search</a>
        </div>
        
        {% if rooms %}
            <p style="color: black; font-weight: bold;" class="lead text">Found {{ rooms.count }} available rooms matching your criteria:</p>
            
            <div class="row row-cols-1 row-cols-md-2 g-4">
                {% for room in rooms %}
                    <div class="col">
                        <div class="card h-100 shadow-sm border-">
                            <div class="card-body">
                                
                                {% if user.is_authenticated %}
                            
                            {# ðŸŒŸ USE CUSTOM TAG: Check favorites status directly ðŸŒŸ #}
                            {% is_favorited room.id as is_favorited_bool %}
                            
                            <div class="love-button-container">
                                <button 
                                    type="button" 
                                    class="btn-love {% if is_favorited_bool %}loved{% endif %}" 
                                    data-room-id="{{ room.id }}" 
                                    aria-label="Toggle favorites">
                                    <i class="fa fa-heart"></i>
                                </button>
                            </div>
                            
                        {% else %}
                            {# If user is not authenticated, show a link to login #}
                            <div class="love-button-container">
                                <a href="{% url 'login' %}" class="btn-love" aria-label="Login to favorite">
                                    <i class="fa fa-heart"></i>
                                </a>
                            </div>
                        {% endif %}
                                
                                <h5 style="color: black; font-weight: bold;" class="card-title text-">Room no #{{ room.room_number }} - {{ room.room_type }}</h5>
                                <h6 style="color: rgb(0, 99, 239);" class="card-subtitle mb-2 text-"> {{ room.hotel.hotel_name }}</h6>

                                {% if room.photo %}
                                    <img style="width: 150px; height: 150px;" src="{{ room.photo.url }}">
                                {% endif %}
                                
                                <p>{{room.description }}</p>
                                <p style=" color: green;">â‚¹{{ room.price_per_night }}<span style="color: black;">/ night</span></p>
                                <a href="{% url 'room_detail' pk=room.id %}" class="btn btn-sm btn-outline-primary">View Details & Book</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <!-- PAGINATION BLOCK START -->
        {% if is_paginated %}
        <div class="d-flex justify-content-center mt-5 mb-5">
            <nav>
                <ul class="pagination">
                    
                    <!-- Previous Page Link -->
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&query={{ request.GET.query }}" aria-label="First">
                            <span aria-hidden="true">&laquo; First</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&query={{ request.GET.query }}" aria-label="Previous">
                            <span aria-hidden="true">Previous</span>
                        </a>
                    </li>
                    {% endif %}

                    <!-- Current Page Number -->
                    <li class="page-item active" aria-current="page">
                        <span class="page-link">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    <!-- Next Page Link -->
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}&query={{ request.GET.query }}" aria-label="Next">
                            <span aria-hidden="true">Next</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&query={{ request.GET.query }}" aria-label="Last">
                            <span aria-hidden="true">Last &raquo;</span>
                        </a>
                    </li>
                    {% endif %}
                    
                </ul>
            </nav>
        </div>
        {% endif %}
        <!-- PAGINATION BLOCK END -->
            
        {% else %}
            <div class="alert alert-warning text-center p-5 mt-5">
                <i class="fa fa-info-circle fa-2x mb-3"></i>
                <h4 class="alert-heading">No Rooms Found!</h4>
                <p>We couldn't find any available rooms that match your search criteria. Try a different query.</p>
                <a href="{% url 'room_search' %}" class="btn btn-warning mt-3">Start New Search</a>
            </div>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
        {% csrf_token %}
    {% endif %}

    <style>
        /* Position the button on the top right of the card body */
        .love-button-container {
            position: absolute; 
            top: 10px;
            right: 10px;
        }

        .btn-love {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 1.5rem; 
            transition: color 0.2s ease, border 0.2s ease; 
        }

        /* Default state: Black outline (empty heart) */
        .btn-love .fa-heart {
            font-weight: 400; 
            color: black;
            text-shadow: 0 0 1px black;
        }

        /* Loved state: Red fill (solid heart) */
        .btn-love.loved .fa-heart {
            font-weight: 900; 
            color: red; 
            text-shadow: none; 
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loveButtons = document.querySelectorAll('.btn-love');
            
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfTokenElement ? csrfTokenElement.value : null;

            const toggleUrl = "{% url 'toggle_favourite' %}"; 

            if (!csrfToken && "{% if user.is_authenticated %}true{% else %}false{% endif %}" === 'true') {
                console.error("Critical Error: User is authenticated but CSRF Token is missing.");
                return;
            }

            // Function to handle the AJAX call
            function toggleFavourite(button, roomId) {
                fetch(toggleUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken, 
                        'X-Requested-With': 'XMLHttpRequest' 
                    },
                    body: JSON.stringify({ room_id: roomId })
                })
                .then(response => {
                    
                    if (response.headers.get('content-type') && !response.headers.get('content-type').includes('application/json')) {
                        throw new Error('You may have been logged out. Please refresh and log in.');
                    }
                    
                    if (!response.ok) {
                        return response.json().then(err => { 
                            throw new Error(err.message || `Server responded with status ${response.status}.`); 
                        });
                    }
                    
                    return response.json();
                })
                .then(data => {
                    // Toggle the class ONLY on successful response
                    button.classList.toggle('loved');
                    console.log(data.message);
                })
                .catch(error => {
                    console.error('Error toggling favourite:', error);
                    alert(`Could not update favorites. Error: ${error.message}`);
                });
            }

            loveButtons.forEach(button => {
                if (button.tagName === 'BUTTON') {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();

                        const roomId = this.getAttribute('data-room-id');
                        
                        if (!csrfToken) {
                            alert("Cannot perform action. Please log in or refresh the page.");
                            return;
                        }
                        
                        toggleFavourite(this, roomId);
                    });
                }
            });
        });
    </script>
{% endblock %}